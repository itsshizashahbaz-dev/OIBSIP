/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(()=>{const e="-shared",t="acrobatDisconnectContentScriptStart",n="acrobatContentScriptDisconnectEnd",o="acrobat-prompt",i="acrobat-fte-tooltip-container",r="acrobat-gdrive-fte-state";let a,c,s,l,d,p,u,m,g,h,v=!1,w=!1,b=!1,f=!1;const E=()=>!chrome.runtime?.id,T=()=>window.location.pathname.includes("/file"),C=e=>{m?.sendAnalytics(e)},y=t=>{if(v||t){const t=document.getElementsByClassName(o);if(t?.length>0){const e=t[0].getElementsByClassName(i);e?.length>0&&C(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),t[0].remove()}const n=document.getElementsByClassName(o+e);n?.length>0&&n[0].remove();const r=document.getElementById("acrobat-prompt");r?.remove(),v=!1}},D=()=>((e,t)=>{if(e){const n=p?.config?.selectors,o=n&&n[t];for(let t=0;t<o?.length;t++){let n=e.querySelector(o[t]);if(n)return n}}return null})(document,"fileDetails"),S=e=>{if("Enter"===e.key||32===e.keyCode||"click"===e.type){if(E())return void y();const{acrobatTouchPointClicked:t,getAcrobatTouchPointFteEligibility:n}=u;t(r),p.fteToolTip.touchPointClicked=!0;const o=D(),i=m?.getFileDetails(o);let a="DCBrowserExt:Gdrive:OpenInExtension:Clicked";"Enter"===e.type&&(a="DCBrowserExt:Gdrive:OpenInExtension:EnterKeyDown"),32===e.keyCode&&(a="DCBrowserExt:Gdrive:OpenInExtension:SpaceKeyDown"),C([[a,{gsuiteFte:n(p?.config?.enableFteToolTip)}]]),chrome.runtime.sendMessage({main_op:"akamai-ping"});let c=m?.buildAcrobatPromotionSource("gdrive_chrome","native_view");!1!==p?.addOnStatus?.isAddOnDefault&&(c=m?.buildAcrobatPromotionSource("gdrive_chrome","native_view","NDV"));const s=chrome.runtime.getURL("viewer.html")+"?pdfurl="+encodeURIComponent(`https://drive.usercontent.google.com/download?id=${i.id}&authuser=${p?.userId}&acrobatPromotionSource=${c}`)+"&pdffilename="+encodeURIComponent(i.title);window.open(s,"_blank")}},L=()=>{const t=document.createElement("div"),n=(()=>{const e=T()?"acrobat-icon-shared":"acrobat-icon";return m?.createAcrobatIconElement(e,"browser/images/acrobat_dc_appicon_128.png")})(),i=(()=>{const e=document.createElement("span"),t=T()?"acrobat-prompt-text-shared":"acrobat-prompt-text";return e.setAttribute("class",t),e.textContent=p?.config?.acrobatPromptText||"Edit with Acrobat",e})(),r=(()=>{const e=document.createElement("div"),t=T()?"acrobat-prompt-tooltip":"acrobat-prompt-tooltip-shared";return e.setAttribute("class",t),e.textContent=p?.config?.acrobatPromptText||"Open in Acrobat",e})(),a=T()?o+e:o;return t.setAttribute("class",a),t.appendChild(n),t.appendChild(r),t.appendChild(i),t.tabIndex=0,t.addEventListener("keydown",e=>{S(e)},{signal:p?.eventControllerSignal}),t.addEventListener("click",e=>{S(e)},{signal:p?.eventControllerSignal}),t},x=async()=>{[u,c,m,h,s,g]=await Promise.all([import(chrome.runtime.getURL("content_scripts/utils/fte-utils.js")),import(chrome.runtime.getURL("content_scripts/gdrive/touchpoint-service.js")),import(chrome.runtime.getURL("content_scripts/utils/util.js")),import(chrome.runtime.getURL("content_scripts/gdrive/search-handler.js")),import(chrome.runtime.getURL("content_scripts/gdrive/default-viewership-service.js")),import(chrome.runtime.getURL("content_scripts/gdrive/api-parsing-util.js"))])},F=async()=>{l=(await import(chrome.runtime.getURL("content_scripts/express/gdrive/express-gdrive-touchpoint-service.js")))?.expressGdriveTouchpointService},k=e=>{const t=document.getElementsByClassName(i);"Enter"!==e.key&&"ArrowLeft"!==e.key&&"ArrowRight"!==e.key&&"click"!==e.type||t?.length>0&&(t[0]?.contains(e.target)||(t[0].remove(),C(["DCBrowserExt:GdriveFTE:NativeView:Dismissed"]),document.removeEventListener("click",k),document.removeEventListener("keydown",k)))},A=e=>{gdriveAcrobatFteCoachmark?.setEligibility(!0,()=>{const{createFteTooltip:t}=u,n=t(!1===p?.addOnStatus?.isAddOnDefault?p?.config?.fteToolTipStrings:p?.config?.fteToolTipStringsForNativeViewNonDV,"gdriveNativeView");(e=>{e.querySelector(".acrobat-fte-tooltip-button").addEventListener("click",()=>{e.remove(),C(["DCBrowserExt:GdriveFTE:NativeView:Clicked"]),document.removeEventListener("click",k),document.removeEventListener("keydown",k)})})(n),document.addEventListener("click",k,{signal:p?.eventControllerSignal}),document.addEventListener("keydown",k,{signal:p?.eventControllerSignal}),e.appendChild(n),C(["DCBrowserExt:GdriveFTE:NativeView:Shown"]);const{updateFteToolTipCoolDown:o}=u;o(p?.config?.fteConfig?.tooltip,r).then(e=>{p.fteToolTip={...p?.fteToolTip,...e}})}),chrome.runtime.sendMessage({main_op:"reRenderShowOneChild"})},_=()=>{try{if(v)return;const t=L(),n=(()=>{let e;for(let t=0;t<p?.config?.selectors?.promptParentElement.length&&(e=document.querySelector(p?.config?.selectors?.promptParentElement[t]),!e);t++);return e})(),i=T()?o+"-"+e:o;if(n&&0===n?.getElementsByClassName(i)?.length){if(n.prepend(t),v=!0,window.innerWidth>1080){C([["DCBrowserExt:Gdrive:OpenInExtension:Shown",{gsuiteFte:u?.getAcrobatTouchPointFteEligibility(p?.config?.enableFteToolTip)}]]);const{shouldShowFteTooltip:e}=u,n=p?.config?.fteConfig?.tooltip;e(n,p?.fteToolTip,p?.config?.enableFteToolTip).then(e=>{e&&setTimeout(()=>{A(t)},1e3)})}}else y()}catch(e){y()}},P=()=>{if(b)try{(()=>{const e=D();if(e){const t=m?.getFileDetails(e);"application/pdf"===t?.mimeType?_():y()}else y()})(),p?.config?.enableGDriveSearchBarAnalytics&&h?.checkForSearchBarDiv(),(p?.config?.enableGDriveSearchBarAnalytics||s?.isDefaultViewer())&&h?.checkForSearchResultsTable(),p?.pageLoaded&&c?.processForTouchPoint()}catch(e){}},G=()=>{f&&l?.addExpressNativeViewerTouchpoint()},R=()=>{if(document?.body)try{const e={childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]};d=new MutationObserver(function(){d.takeRecords(),E()?(d.disconnect(),B(),p?.disconnectEventListeners()):(P(),G())}),d.observe(document?.body,e)}catch(e){}else setTimeout(R,500)},B=()=>{y(!0),c?.removeAllTouchPoints(),l?.removeExpressTouchpoints()},V=()=>{E()&&(d&&d.disconnect(),y(),p?.disconnectEventListeners(),window.dispatchEvent(new CustomEvent(n,{detail:{state:p.createStateTransferObject()}})))},I=()=>{window.addEventListener(n,e=>(e=>{E()||p.updateStateFromTransferObject(e?.detail?.state)})(e),{signal:p?.eventControllerSignal}),window.dispatchEvent(new Event("orphanContentScript")),window.dispatchEvent(new Event(t)),window.addEventListener(t,V,{signal:p?.eventControllerSignal})},O=()=>{Promise.all([chrome.runtime.sendMessage({main_op:"gdrive-init"}),chrome.runtime.sendMessage({main_op:"gdrive-express-init"})]).then(async([e,t])=>{(e?.acrobatTouchPointEnabled||e?.isAcrobatDefaultForSurface||t?.enableGdriveNativeViewerExpressMenu)&&(j(e),await((e,t)=>{const n=chrome.runtime.getURL("content_scripts/gdrive/state.js");return import(n).then(n=>{p=n.default,p.config=e,p.expressConfig=t,p.acrobatIconPath="browser/images/acrobat_dc_trefoil_24_white.svg"})})(e,t),I(),b=(e?.acrobatTouchPointEnabled||e?.isAcrobatDefaultForSurface)&&(e?.enableOpenInExtension||window.location?.search?.includes("enableAcrobatPromptInGSuite")),f=t?.enableGdriveNativeViewerExpressMenu,(b||f)&&Promise.all([x(),F()]).then(()=>{m.addFontToDocument(p),U(),b&&(m?.sendAnalyticsOncePerMonth("DCBrowserExt:Gdrive:OpenInExtension:Enable"),(e?.enableFteToolTip||e?.enableFteToolTipForListGridView)&&m?.sendAnalyticsOncePerMonth("DCBrowserExt:GdriveFTE:Enable"),(()=>{if(window?.document?.location?.pathname.includes("/u/"))return void(p.userId=window.document.location.pathname.split("/")[3]);const e=document.createElement("script");document.addEventListener("acrobat-auth-user-id",t=>{p.userId=t?.detail?.authuser,e.remove()}),e.type="text/javascript",e.src=chrome.runtime.getURL("content_scripts/gdrive/get-auth-user.js"),document.head.appendChild(e)})(),a=chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"),(async()=>{const e=(new Date).getTime();let t={count:0,nextDate:e};t=(await chrome.storage.local.get(r))?.[r]||t;const n=p?.config?.fteConfig?.tooltip;((e,t)=>-1!==e?.resetDay&&t>e?.resetDay)(n,e)&&(t.count=0,t.nextDate=e),p.fteToolTip={...t},t={[r]:t},chrome.storage.local.set(t)})(),B(),N(),P()),f&&G(),R()}))})},N=()=>{p?.config?.enableGDriveTripleDotMenuAnalytics&&(document.addEventListener("click",e=>{c?.handleAnalyticsForTripleDotMenu(e),c?.handleAnalyticsForTopMenu(e)},{signal:p?.eventControllerSignal}),document.addEventListener("contextmenu",e=>{c?.handleAnalyticsForRightClickMenu(e)},{signal:p?.eventControllerSignal}))},U=()=>{window.addEventListener("load",()=>{setTimeout(()=>{p.pageLoaded=!0},500)})},j=e=>{if(!w&&(w=!0,e?.enableGDriveGridViewTouchPoint||e?.enableGDriveListViewTouchPoint)){const e=document.createElement("script");e.setAttribute("id","acrobat-response-interceptor"),e.src=chrome.runtime.getURL("content_scripts/gdrive/gdrive-inject.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e)}};document.addEventListener("acrobat-addon-status-data",e=>{setTimeout(()=>{g?.handleGDriveInstalledAppResponse(e)},0)},{signal:p?.eventControllerSignal}),document.addEventListener("gdrive-search-bar-api-response",e=>{s?.isDefaultViewer()&&e?.detail?.searchResponse&&g?.processSearchApiResponse(e)},{signal:p?.eventControllerSignal}),chrome.runtime.onMessage.addListener(function(e){switch(e.content_op){case"acrobatGdriveFteStateUpdated":(e=>{p.fteToolTip={...p?.fteToolTip,...e?.fteState}})(e);break;case"acrobatTouchPointsDisabled":p?.config?.isAcrobatDefaultForSurface||(d?.disconnect(),B());break;case"changeDefaultViewershipForSurface":"gdrive"===e?.surfaceId&&chrome.runtime.id&&(e?.isDefault?s?.takeDefaultViewerShip():s?.resetDefaultViewership())}}),(async()=>{"drive.google.com"===window?.document?.location?.host&&window.top===window.self&&0===window?.document?.location?.ancestorOrigins.length&&O()})()})();