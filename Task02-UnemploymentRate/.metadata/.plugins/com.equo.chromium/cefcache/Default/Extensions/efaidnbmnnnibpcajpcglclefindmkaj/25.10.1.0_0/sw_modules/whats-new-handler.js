/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e}from"../common/local-storage.js";import{analytics as t}from"../common/analytics.js";import{loggingApi as a}from"../common/loggingApi.js";import{communicate as r}from"./communicate.js";import{floodgate as n}from"./floodgate.js";import{CACHE_PURGE_SCHEME as s}from"./constant.js";const i="whatsNewVersionCheck",o=864e5;async function c(){try{if(!navigator.onLine)return!1;const t=e.getItem("whatsNewState")||{},a=t?.whatsNewJsonUrl;if(!a)return!1;const r=new URL(a),n=await fetch(r.toString(),{method:"GET"});if(!n.ok)throw new Error(`Failed to fetch wn.json: ${n.status}`);let s=await n.json();s=s.slice(0,13);const i=s[0];if(!i)return!1;const o=e.getItem("whatsNewState")?.lastSeenWn?.version,c=!o||o!==i.whatsNewVersion;if(c){const t=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...t,currentAvailableWN:i.whatsNewVersion})}return c}catch(e){return a.error({message:"WhatsNew VersionCheck Failed",error:e?.message}),!1}}async function l(){try{const t=await n.hasFlag("dc-cv-whats-new",s.NO_CALL);if(e.setItem("whatsNew",!!t),!t)return void w();let r=10080;r=function(e,t=10080){if(!e)return t;try{const{alarmInterval:a}=JSON.parse(e)||{},r=parseInt(a,10);return Number.isFinite(r)&&r>0?r:t}catch{return t}}(n.getFeatureMeta("dc-cv-whats-new"));const o=await chrome.alarms.get(i);o&&o?.periodInMinutes===r||(await w(),chrome.alarms.create(i,{periodInMinutes:r,delayInMinutes:1}),a.info({message:"WhatsNew Alarm Created"}))}catch(e){}}async function w(){try{await chrome.alarms.get(i)&&chrome.alarms.clear(i)}catch(e){}}async function u(e){if(e&&e.name===i){if(!await n.hasFlag("dc-cv-whats-new",s.NO_CALL))return void await w();try{await c()&&a.info({message:"WhatsNew New Version Detected"})}catch(e){}}}async function m(t="browserStartup"){try{if(!navigator.onLine)return{eligible:!1,reason:"offline"};if(!await n.hasFlag("dc-cv-whats-new",s.NO_CALL))return{eligible:!1,reason:"ff_disabled"};const{whatsNewState:a={},whatsNewAutoOpen:r}=e.getItems(["whatsNewState","whatsNewAutoOpen"]),{currentAvailableWN:i,lastSeenWn:c,disableAutoOpenByAdmin:l}=a||{};if(!0===l)return{eligible:!1,reason:"admin_disabled"};if(!i)return{eligible:!1,reason:"no_current_wn"};const w=Date.now();if("browserStartup"===t){if(c?.version&&i===c.version)return{eligible:!1,reason:"already_seen_version"};const t=e.getItem("installTimestamp");if(!c&&(t?(w-t)/o:0)<=15)return{eligible:!1,reason:"new_user_grace"};if("false"===r)return{eligible:!1,reason:"auto_open_toggle_off"};if(c?.timestamp){if((w-c.timestamp)/o<=25)return{eligible:!1,reason:"cooldown"}}}return{eligible:!0,currentAvailableWN:i}}catch{return{eligible:!1,reason:"error"}}}async function h(r){try{if(!navigator.onLine)return;const n=await m(r);if(!n?.eligible)return;const s=n.currentAvailableWN,i=Date.now(),o=function(){try{const t=e.getItem("whatsNewState")?.whatsNewPageUrl;return t||(a.error({message:"No What's New URL found in servers config"}),null)}catch(e){return null}}();if(o){const a=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...a,currentWhatsNewOpenSource:r}),await chrome.tabs.create({url:o,active:!0});const n={version:s,timestamp:a.lastSeenWn?.timestamp};"browserStartup"===r&&(n.timestamp=i);const c=e.getItem("whatsNewState")||{};e.setItem("whatsNewState",{...c,lastSeenWn:n}),t.event("DCBrowserExt:WhatsNew:PageOpened",{version:s,trigger:r})}}catch(e){}}r.registerHandlers({getWhatsNewData:async function(t,a,r){try{let t=e.getItem("whatsNewState")||{};const a=t.currentWhatsNewOpenSource;if(a){const{currentWhatsNewOpenSource:a,...r}=t;e.setItem("whatsNewState",r),t=r}const{appLocale:n,viewerLocale:s,locale:i,isAllowedLocalFileAccess:o}=e.getItems(["appLocale","viewer-locale","locale","isAllowedLocalFileAccess"]),c=t.currentAvailableWN,l=n||s||i;r({success:!0,currentExtensionVersion:chrome.runtime.getManifest().version,whatsNewVersion:c,locale:l,source:a||"direct",isAllowedLocalFileAccess:o})}catch(e){return{success:!1,error:e.message}}},openWhatsNew:({source:e})=>h(e),getWhatsNewAutoOpenEligibility:async function(e,t,r){try{if(await n.hasFlag("dc-cv-whats-new",s.NO_CALL)){await c()&&a.info({message:"WhatsNew New Version Detected"})}r({eligible:!!(await m()).eligible})}catch(e){r({eligible:!1})}}});export{w as clearWhatsNewVersionCheckAlarm,u as whatsNewAlarmHandler,h as checkAndOpenWhatsNewPage,l as checkAndInitialiseWhatsNewAlarm};