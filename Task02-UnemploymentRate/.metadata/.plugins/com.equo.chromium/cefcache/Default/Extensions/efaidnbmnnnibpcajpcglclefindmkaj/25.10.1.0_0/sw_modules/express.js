/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e,events as t}from"../common/analytics.js";import{dcLocalStorage as r,dcSessionStorage as o}from"../common/local-storage.js";import{loggingApi as n}from"../common/loggingApi.js";import{EXPRESS as a}from"./constant.js";import{floodgate as s}from"./floodgate.js";import{util as i}from"./util.js";import{common as c}from"./common.js";import{OFFSCREEN_DOCUMENT_PATH as m}from"../common/constant.js";import{sendCoiEnabledEvent as E,sendPingEventHandler as S}from"../common/util.js";const p={},d="cleanUpExpressAssetMemoryMap",l="cleanUpExpressIndexedDB",u={beta:["memepcobodlebmohdlfnjiaalggfcpic","hgednelcgbmkdebjhejlmbgigmkcbemg"],release:["efaidnbmnnnibpcajpcglclefindmkaj","elhekieabhbkpmcefcoobjddigjcaadp"]},f={[a.VERBS.EFFECTS_IMAGE]:"add-effects",[a.VERBS.CROP_IMAGE]:"crop-image",[a.VERBS.REMOVE_BACKGROUND_IMAGE]:"remove-background",[a.VERBS.INSERT_OBJECT]:"insert-object",[a.VERBS.REMOVE_OBJECT]:"remove-object"},g="Response not in 2xx range.";async function I(e,t=!1){const r=Date.now();let o,a=e;if(t=t&&i.isBrowserVersionGreaterThan116())try{a=await async function(e){const t=`${m}?env=${c.getEnv()}`;await i.setupOffscreenDocument(t);const r=await chrome.runtime.sendMessage({main_op:"fetchImageBlobURL",target:"offscreen",imgUrl:e});if(r.error)throw new Error(r.error);return r.blobUrl}(e)}catch(e){n.error({message:"Error fetching image blob url from offscreen",error:e.toString()})}try{if(o=await fetch(a),a!==e&&(s=a,chrome.runtime.sendMessage({main_op:"revokeImageBlobURL",target:"offscreen",blobUrl:s})),!o.ok){throw new Error(a!==e?"Blob fetch response not in 2xx range.":g,{cause:{status:o.status}})}}catch(t){if(a===e)throw t;n.error({message:"Error fetching image from offscreen blob url",error:t.toString()});try{o=await fetch(e)}catch(e){throw new Error(g,{cause:{status:o.status}})}}var s;const E=await o.blob();return new Promise((e,t)=>{const o=new FileReader;o.readAsDataURL(E),o.onloadend=()=>{const t=o.result,n=Date.now()-r;e({base64data:t,imageDownloadTime:n})},o.onerror=t})}function R(e){return f[e]??"edit-image"}function h(e){return(o.getItem(a.EXPRESS_SESSIONS)||{})[e]}async function _(e,t){const r=Date.now(),n=new URL(t.url).hostname,c=e.srcUrl,m=t.id,S=e.intent,p=e.touchpoint,d=await async function(){return await s.hasFlag("dc-cv-express-standalone")?a.VARIANT.LOE:a.VARIANT.MODAL}(),l=i.uuid(),u=o.getItem(a.EXPRESS_SESSIONS)||{};let f={};try{f=JSON.parse(s.getFeatureMeta("dc-cv-express-error-handling-optimization"))??{}}catch(e){}const g=o.getItem(a.COI_ENABLED_TABS)?.[m],I=!!g;return E(m,{domain:n,expressTouchpoint:p}),u[l]={pageDomain:n,imageURL:c,tabId:m,intent:S,touchpoint:p,variant:d,clickTimeStamp:r,errorHandlingConfig:f,coiEnabled:I},o.setItem(a.EXPRESS_SESSIONS,u),l}async function A(e,t){"ContextMenu"!==e.touchpoint&&S();const r=await _(e,t);await x(r)}function b(e){const t=o.getItem(a.EXPRESS_SESSIONS)||{};return Object.keys(t).find(r=>{const n=t[r];return n.tabId===e&&!n.fetchedFromContentScript&&n.variant===a.VARIANT.MODAL&&(t[r].fetchedFromContentScript=!0,o.setItem(a.EXPRESS_SESSIONS,t),!0)})}async function x(s){const m=h(s);let E;const S=m?.pageDomain;try{if(E=m.intent,m.variant===a.VARIANT.LOE){const e=m.clickTimeStamp,t=e+864e5;expressIndexedDBScript.storeExpressAssetInfoInIndexedDB(s,m.imageURL,t,e),chrome.alarms.get(l,e=>{e||chrome.alarms.create(l,{periodInMinutes:720})}),p[s]={bufferPromise:I(m.imageURL),ttl:Date.now()+6e5,clickTimeStamp:e,domain:S},chrome.alarms.get(d,e=>{e||chrome.alarms.create(d,{periodInMinutes:10})});const o=new URL(c.getExpressURLs().webAppUrl);o.searchParams.append("expressSessionId",s),o.searchParams.append("referrer",a.REFERRER);const n=R(m.intent);o.searchParams.append("editAction",n),o.searchParams.append("extId",function(){const e=Object.keys(u).filter(e=>u[e].includes(chrome.runtime.id));return e.length>0?e[0]:"release"}());const E=i.getFrictionlessLocale(chrome.i18n.getMessage("@@ui_locale"));o.searchParams.append("locale",E),"true"===r.getItem("adobeInternal")&&o.searchParams.append("setting-consoleLogLevel-performance","info"),chrome.tabs.create({url:o.href,active:!0})}else!function(e,t,r){let n=o.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];n.push({tabId:e,touchpoint:t,domain:r}),o.setItem(a.SESSIONS_WHERE_MODAL_LOADING,n)}(m.tabId,m?.touchpoint,S),await chrome.scripting.executeScript({target:{tabId:m.tabId},files:["content_scripts/express-content-script.js"]})}catch(r){L(m?.tabId,m?.touchpoint,S),e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{VERB:E,eventContext:r.toString(),expressTouchpoint:m?.touchpoint,domain:S}),n.error({message:"Error executing express verb",error:"Initiate execute verb from service worker: "+r.toString()})}}async function O(o){if(!p[o])return async function(r){let o,s,i;const c=h(r),m=await expressIndexedDBScript.getExpressAssetInfoFromIndexedDB(r);if(!m)return n.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${a.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST}`}),{status:a.RESPONSE_STATUS.FAILED,errorCode:a.EXTERNAL_MESSAGING_ERROR_CODES.INVALID_REQUEST};o=m.url,s=m.clickTimeStamp;try{i=(await I(o)).base64data}catch(r){return e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:r.toString(),domain:c?.pageDomain,expressTouchpoint:c?.touchpoint}),n.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${r.toString()}`}),{status:a.RESPONSE_STATUS.FAILED,errorCode:a.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED,clickTimeStamp:s}}return{status:a.RESPONSE_STATUS.SUCCESS,buffer:i,clickTimeStamp:s}}(o);{const s=h(o)?.touchpoint,i=p[o]?.domain,c=p[o].clickTimeStamp,m=Date.now()-c;try{const{base64data:e,imageDownloadTime:t}=await p[o].bufferPromise,s=Date.now()-c;"true"===r.getItem("adobeInternal")&&(console.log("Time required to receive request from express webapp "+m),console.log("Image Download Time "+t),console.log("Time required to handover to express "+s));const E={imageDownloadTime:t,timeRequiredToHandoverToExpress:s,expressCommunicationReceivedTime:m,imageSize:e.length};return n.info({message:a.PERF_METRIC_LOG_MESSAGE,...E}),{status:a.RESPONSE_STATUS.SUCCESS,buffer:e,clickTimeStamp:c,domain:i}}catch(r){e.event(t.EXPRESS_EXECUTE_VERB_FAILED,{eventContext:r.toString(),domain:i,expressTouchpoint:s}),n.error({message:"Error executing express verb",error:`Asset transfer to LOE failed: ${r.toString()}`});const o=a.EXTERNAL_MESSAGING_ERROR_CODES.IMAGE_FETCH_FAILED;return{status:a.RESPONSE_STATUS.FAILED,errorCode:o,clickTimeStamp:c,domain:i}}}}function T(e){chrome.scripting.executeScript({target:{tabId:e},func:()=>{!function(e){const t=document.querySelector(`#${e}`);t?.parentElement?.removeChild(t),document.body.style.overflow=overflowStyleBeforeExpressOpened,overflowStyleBeforeExpressOpened=void 0}("expressAcrobatExtension"),dialogToBeReopened&&(dialogToBeReopened.showModal(),dialogToBeReopened=void 0)}})}function D(r){const s=function(e){let t=[],r=o.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];r=r.filter(r=>r.tabId!==e||(t.push(r),!1)),t.length>0&&o.setItem(a.SESSIONS_WHERE_MODAL_LOADING,r);return t}(r);s.forEach(r=>{const o="Tab closed before express modal opened";n.error({message:"Error executing express verb",error:o}),e.event(t.EXPRESS_TAB_CLOSED_BEFORE_EXPRESS_LOADED,{eventContext:o,expressTouchpoint:r.touchpoint,domain:r.domain})})}function L(e,t,r){let n=o.getItem(a.SESSIONS_WHERE_MODAL_LOADING)||[];const s=n.findIndex(o=>o.tabId===e&&o.touchpoint===t&&o.domain===r);s>-1&&(n.splice(s,1),o.setItem(a.SESSIONS_WHERE_MODAL_LOADING,n))}chrome.alarms.onAlarm.addListener(function(e){e&&e.name===d&&(Object.keys(p).forEach(e=>{p[e]?.ttl<Date.now()&&delete p[e]}),0===Object.keys(p).length&&chrome.alarms.clear(d))}),chrome.alarms.onAlarm.addListener(function(e){e&&e.name===l&&expressIndexedDBScript.removeExpressAssetInfoFromIndexedDB().then(()=>{expressIndexedDBScript.getExpressAssetCount().then(e=>{0===e&&chrome.alarms.clear(l)})})});export{x as executeExpressVerb,T as closeExpress,O as getExpressAssetResponse,I as imageUrlToBase64,R as verbNameToIntent,L as removeSessionFromUnloadedExpressSessions,D as expressModalTabCloseListener,b as getModalSessionId,h as getExpressSession,A as launchExpress};